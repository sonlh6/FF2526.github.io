<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fantasy Football Stats Tracker</title>
    <meta http-equiv="refresh" content="0;url=https://fifa2526-94lx.onrender.com/">
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- SheetJS (for Excel export) -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success-gradient: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            --warning-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --info-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }

        .navbar {
            background: var(--primary-gradient) !important;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .card {
            border: none;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }

        .stat-card {
            background: var(--primary-gradient);
            color: white;
        }

        .stat-card.success { background: var(--success-gradient); }
        .stat-card.warning { background: var(--warning-gradient); }
        .stat-card.info { background: var(--info-gradient); }

        .manager-card {
            background: white;
            margin-bottom: 20px;
        }

        .manager-card .card-header {
            background: var(--info-gradient);
            color: white;
            border-radius: 20px 20px 0 0 !important;
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
        }

        .btn-gradient {
            background: var(--primary-gradient);
            border: none;
            border-radius: 25px;
            padding: 10px 30px;
            color: white;
            transition: all 0.3s ease;
        }

        .btn-gradient:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            color: white;
        }

        .manager-input-section {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-spinner {
            background: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
        }

        .manager-list-item {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .manager-list-item:hover {
            background: var(--info-gradient);
            color: white;
        }

        .gw-point-badge {
            font-size: 14px;
            padding: 5px 10px;
            border-radius: 15px;
            margin: 2px;
            display: inline-block;
        }

        .point-high { background: #28a745; color: white; }
        .point-medium { background: #ffc107; color: black; }
        .point-low { background: #dc3545; color: white; }

        @media (max-width: 768px) {
            .chart-container { height: 300px; }
            .card { margin-bottom: 20px; }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        th[data-sort] {
            position: relative;
            cursor: pointer;
        }
        th[data-sort]::after {
            content: ' \2195'; /* up-down arrow */
            opacity: 0.3;
        }
        th.sort-asc::after, th.sort-desc::after {
            opacity: 1;
        }
        th.sort-asc::after { content: ' \25B2'; } /* up triangle */
        th.sort-desc::after { content: ' \25BC'; } /* down triangle */
        .bg-bronze { background-color: #cd7f32 !important; color: white; }
        .text-bronze { color: #cd7f32 !important; }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner">
            <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;"></div>
            <h5>Đang tải dữ liệu...</h5>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="navbar navbar-dark">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="bi bi-trophy"></i> Fantasy Football Stats Tracker
            </span>
            <div class="d-flex align-items-center">
                <span class="navbar-text me-3" id="connectionStatus">
                    <i class="bi bi-wifi"></i> Đang kiểm tra...
                </span>
                <button class="btn btn-outline-light btn-sm" onclick="refreshAllData()">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Comparison Section -->
        <div class="card mb-4 fade-in" id="comparisonSection" style="display: none;">
            <div class="card-header" style="background: var(--primary-gradient);">
                <h3 class="mb-0 text-white"><i class="bi bi-trophy-fill"></i> Bảng Xếp Hạng & So Sánh</h3>
            </div>
            <div class="card-body p-4">
                <div class="mb-4">
                    <button class="btn btn-gradient" onclick="compareAllManagers()">
                        <i class="bi bi-graph-up"></i> Cập nhật Bảng Xếp Hạng
                    </button>
                    <button class="btn btn-success ms-2" onclick="exportToExcel()">
                        <i class="bi bi-file-earmark-excel"></i> Xuất Excel
                    </button>
                </div>
                <div id="comparisonCharts"></div>
            </div>
        </div>

        <!-- Individual Manager Stats -->
        <div id="managerStatsContainer"></div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="toast" class="toast" role="alert">
            <div class="toast-header">
                <i class="bi bi-info-circle text-primary me-2"></i>
                <strong class="me-auto">Thông báo</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="toastMessage"></div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Initialize managers array from data passed by Django
        let managers = {{ managers|tojson|safe }};
        let charts = {};
        let processedComparisonData = [];
        let reversedWeeklyScores = [];
        let currentSort = { key: 'total_points', dir: 'desc' };
        let topScores = {};
        let rankMap = new Map();
        let currentGameweek = null;
        let currentGwFinished = true;


        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            checkConnection();
            initializeDashboard();
        });

        function saveManagersToStorage() {
            // Store the full manager objects for faster loading, avoiding API calls on page refresh.
            localStorage.setItem('fantasyManagers', JSON.stringify(managers));
        }

        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            const toastHeader = toast.querySelector('.toast-header i');
            
            toastMessage.textContent = message;
            
            // Change icon based on type
            toastHeader.className = `bi me-2 ${type === 'error' ? 'bi-exclamation-triangle text-danger' : 
                                              type === 'success' ? 'bi-check-circle text-success' : 
                                              'bi-info-circle text-primary'}`;
            
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
        }

        async function checkConnection() {
            try {
                const response = await fetch('/api/test-connection');
                const result = await response.json();
                
                const statusElement = document.getElementById('connectionStatus');
                if (result.success) {
                    statusElement.innerHTML = '<i class="bi bi-wifi text-success"></i> Kết nối OK';
                    statusElement.title = `Gameweek hiện tại: ${result.current_gameweek}`;
                } else {
                    statusElement.innerHTML = '<i class="bi bi-wifi-off text-danger"></i> Lỗi kết nối';
                    statusElement.title = result.error;
                }
            } catch (error) {
                document.getElementById('connectionStatus').innerHTML = '<i class="bi bi-wifi-off text-danger"></i> Lỗi kết nối';
            }
        }

        function addManagerToList(manager) {
            // Check if manager already exists
            if (managers.some(m => m.id === manager.id)) {
                return;
            }

            managers.push(manager);
            saveManagersToStorage();
            loadManagerStats(manager.id, false);

            if (managers.length > 0) {
                document.getElementById('comparisonSection').style.display = 'block';
            }
        }
        function fetchLiveScores() {
            fetch('/api/live-scores')
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        console.log(`Live scores for GW ${result.gameweek}:`, result.data);
                        
                        // Lặp qua danh sách điểm live và cập nhật UI
                        result.data.forEach(score => {
                            // Giả sử bạn có một element để hiển thị tổng điểm,
                            // và bạn muốn thêm điểm live bên cạnh nó.
                            // Ví dụ: <span id="total-points-6219866">...</span>
                            // và bạn sẽ thêm một span mới cho điểm live.
                            const managerCard = document.getElementById(`manager-card-${score.manager_id}`);
                            if (managerCard) {
                                let liveScoreEl = managerCard.querySelector('.live-score');
                                if (!liveScoreEl) {
                                    liveScoreEl = document.createElement('span');
                                    liveScoreEl.className = 'live-score';
                                    // Chèn vào vị trí phù hợp trong card
                                    const titleEl = managerCard.querySelector('h5');
                                    if (titleEl) {
                                        titleEl.appendChild(liveScoreEl);
                                    }
                                }

                                if (score.live_points !== null) {
                                    liveScoreEl.textContent = ` (Live: ${score.live_points} pts)`;
                                    liveScoreEl.style.color = 'green';
                                } else {
                                    liveScoreEl.textContent = ` (Live: Lỗi)`;
                                    liveScoreEl.style.color = 'red';
                                }
                            }
                        });
                    } else {
                        console.error('Không thể lấy điểm live:', result.error);
                    }
                })
                .catch(error => console.error('Lỗi mạng khi lấy điểm live:', error));
        }

        // Bắt đầu gọi hàm khi trang được tải
        document.addEventListener('DOMContentLoaded', () => {
            // Gọi lần đầu
            fetchLiveScores();
            
            // Tự động cập nhật mỗi 60 giây
            setInterval(fetchLiveScores, 60000);
        });    
        async function fetchManagerStatsData(managerId) {
            try {
                const response = await fetch(`/api/manager/${managerId}/stats`);
                const result = await response.json();

                if (result.success) {
                    return result.data;
                } else {
                    showToast(`Lỗi tải dữ liệu manager ${managerId}: ${result.error}`, 'error');
                    return null;
                }
            } catch (error) {
                showToast(`Lỗi kết nối manager ${managerId}: ${error.message}`, 'error');
                return null;
            }
        }

        async function loadManagerStats(managerId, showIndicator = true) {
            if (showIndicator) showLoading();
            try {
                const stats = await fetchManagerStatsData(managerId);
                if (stats) {
                    displayManagerStats(managerId, stats);
                }
                // Error toasts are handled in fetchManagerStatsData
            } catch (error) {
                // This catch is for unexpected errors in the flow, not fetch errors
                showToast(`Lỗi không xác định khi tải manager ${managerId}: ${error.message}`, 'error');
            }
            finally {
                if (showIndicator) hideLoading();
            }
        }

        function displayManagerStats(managerId, stats) {
            const container = document.getElementById('managerStatsContainer');
            
            // Xóa block cũ (nếu có)
            const existing = document.getElementById(`manager-${managerId}-stats`);
            if (existing) existing.remove();

            // --- Lấy dữ liệu gốc và chèn điểm live GW hiện tại (nếu có) ---
            const originalGw = Array.isArray(stats.gameweek_points) ? stats.gameweek_points : [];
            let gwPoints = [...originalGw].sort((a, b) => a.gameweek - b.gameweek);

            // Nếu đang có GW live và backend đã trả live_total_points > total_points
            if (currentGameweek && !currentGwFinished) {
                const hasLive =
                    typeof stats.live_total_points === 'number' &&
                    typeof stats.total_points === 'number' &&
                    stats.live_total_points > stats.total_points;

                if (hasLive) {
                    const livePoints = stats.live_total_points - stats.total_points;

                    const idx = gwPoints.findIndex(g => g.gameweek === currentGameweek);
                    // Tổng trước GW live (dựa theo total_points của GW trước)
                    const prevTotal =
                        gwPoints.length > 0
                            ? (gwPoints.find(g => g.gameweek < currentGameweek)?.total_points ??
                            gwPoints[gwPoints.length - 1].total_points ?? 0)
                            : 0;

                    if (idx !== -1) {
                        // Nếu đã có entry GW hiện tại thì cập nhật
                        gwPoints[idx] = {
                            ...gwPoints[idx],
                            points: livePoints,
                            total_points: prevTotal + livePoints
                        };
                    } else {
                        // Nếu chưa có entry thì thêm mới
                        gwPoints.push({
                            gameweek: currentGameweek,
                            points: livePoints,
                            total_points: prevTotal + livePoints
                        });
                    }
                    gwPoints.sort((a, b) => a.gameweek - b.gameweek);
                }
            }

            // Chuẩn bị dữ liệu cho chart
            const labels = gwPoints.map(gw => `GW${gw.gameweek}`);
            const pointsData = gwPoints.map(gw => gw.points);

            // Tổng điểm tích lũy: ưu tiên dùng total_points nếu có; nếu không thì cộng dồn
            let running = 0;
            const totalPointsData = gwPoints.map(gw => {
                if (typeof gw.total_points === 'number') {
                    running = gw.total_points;
                } else {
                    running += (gw.points || 0);
                }
                return running;
            });

            // --- Render thẻ manager ---
            const managerCard = document.createElement('div');
            managerCard.id = `manager-${managerId}-stats`;
            managerCard.className = 'manager-card card fade-in mb-4';

            managerCard.innerHTML = `
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-0">${stats.manager_info.player_first_name} ${stats.manager_info.player_last_name}</h5>
                            <small>${stats.manager_info.name}</small>
                        </div>
                        <div class="text-end">
                            <div class="h4 mb-0">${stats.live_total_points ?? stats.total_points}</div>
                            <small>Total Points</small>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Stats Overview -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="h3 text-primary">${stats.average_points}</div>
                                <small class="text-muted">Điểm TB/GW</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="h3 text-success">${stats.highest_gameweek ? stats.highest_gameweek.points : 'N/A'}</div>
                                <small class="text-muted">Cao nhất ${stats.highest_gameweek ? `(GW${stats.highest_gameweek.event})` : ''}</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="h3 text-warning">${stats.lowest_gameweek ? stats.lowest_gameweek.points : 'N/A'}</div>
                                <small class="text-muted">Thấp nhất ${stats.lowest_gameweek ? `(GW${stats.lowest_gameweek.event})` : ''}</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="h3 text-info">${stats.gameweeks_played}</div>
                                <small class="text-muted">Gameweeks</small>
                            </div>
                        </div>
                    </div>

                    <!-- Gameweek Points Badges -->
                    <div class="mb-4">
                        <h6 class="mb-3">Điểm theo từng Gameweek:</h6>
                        <div>
                            ${gwPoints.map(gw => {
                                const pointClass = gw.points >= 70 ? 'point-high' : 
                                                gw.points >= 45 ? 'point-medium' : 'point-low';
                                return `<span class="gw-point-badge ${pointClass}" title="GW${gw.gameweek}: ${gw.points} điểm">
                                    GW${gw.gameweek}: ${gw.points}
                                </span>`;
                            }).join('')}
                        </div>
                    </div>

                    <!-- Charts -->
                    <div class="row">
                        <div class="col-lg-6">
                            <h6>Điểm theo Gameweek</h6>
                            <div class="chart-container" style="height: 250px;">
                                <canvas id="chart-points-${managerId}"></canvas>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <h6>Tổng điểm tích lũy</h6>
                            <div class="chart-container" style="height: 250px;">
                                <canvas id="chart-total-${managerId}"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Detailed Table -->
                    <div class="mt-4">
                        <h6>Chi tiết theo Gameweek</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-striped">
                                <thead class="table-dark">
                                    <tr>
                                        <th>GW</th>
                                        <th>Điểm</th>
                                        <th>Tổng điểm</th>
                                        <th>Rank</th>
                                        <th>Bank</th>
                                        <th>Value</th>
                                        <th>Transfers</th>
                                        <th>Bench</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${gwPoints.map(gw => `
                                        <tr>
                                            <td><strong>GW${gw.gameweek}</strong></td>
                                            <td><span class="badge ${gw.points >= 70 ? 'bg-success' : 
                                                                gw.points >= 45 ? 'bg-warning' : 'bg-danger'}">${gw.points}</span></td>
                                            <td>${(typeof gw.total_points === 'number') ? gw.total_points.toLocaleString() : 'N/A'}</td>
                                            <td>${gw.rank?.toLocaleString() || 'N/A'}</td>
                                            <td>${gw.bank !== undefined ? `£${gw.bank}M` : 'N/A'}</td>
                                            <td>${gw.value !== undefined ? `£${gw.value}M` : 'N/A'}</td>
                                            <td>${
                                                gw.event_transfers !== undefined
                                                    ? `${gw.event_transfers}${gw.event_transfers_cost !== undefined ? ` (-${gw.event_transfers_cost})` : ''}`
                                                    : 'N/A'
                                            }</td>
                                            <td>${gw.points_on_bench ?? 'N/A'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;

            container.appendChild(managerCard);

            // Vẽ chart dựa trên dữ liệu đã chèn GW live
            setTimeout(() => {
                createManagerCharts(managerId, labels, pointsData, totalPointsData);
            }, 100);
        }



        function createManagerCharts(managerId, labels, pointsData, totalPointsData) {
            // Points per gameweek chart
            const pointsCtx = document.getElementById(`chart-points-${managerId}`);
            if (pointsCtx) {
                charts[`points-${managerId}`] = new Chart(pointsCtx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Điểm',
                            data: pointsData,
                            backgroundColor: pointsData.map(point => 
                                point >= 70 ? '#28a745' : 
                                point >= 45 ? '#ffc107' : '#dc3545'
                            ),
                            borderRadius: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            }

            // Total points chart
            const totalCtx = document.getElementById(`chart-total-${managerId}`);
            if (totalCtx) {
                charts[`total-${managerId}`] = new Chart(totalCtx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Tổng điểm',
                            data: totalPointsData,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            }
        }

        async function compareAllManagers() {
            if (managers.length < 2) {
                showToast('Cần ít nhất 2 managers để so sánh', 'error');
                return;
            }

            showLoading();

            try {
                const response = await fetch('/api/compare-managers', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ manager_ids: managers.map(m => m.id) })
                });

                const result = await response.json();
                hideLoading();

                if (result.success) {
                    // lưu lại thông tin vòng hiện tại từ backend
                    currentGameweek = result.current_gameweek;
                    currentGwFinished = result.current_gw_finished;

                    // vẽ lại bảng so sánh
                    displayComparison(result.data);
                } else {
                    showToast(result.error, 'error');
                }
            } catch (error) {
                hideLoading();
                showToast('Lỗi so sánh: ' + error.message, 'error');
            }
        }

        // Hàm gọi API backend để thêm hàng loạt manager
        async function addManagersInBulk(ids) {
            showLoading();
            let successCount = 0;
            let failedIds = [];

            // Use Promise.all to send requests in parallel for better performance
            const promises = ids.map(async (id) => {
                try {
                    // Ensure the manager doesn't already exist on the client-side
                    if (managers.some(m => m.id == id)) {
                        return;
                    }

                    const response = await fetch('/api/add-manager', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        // Send 'manager_id' (singular) as the backend seems to expect
                        body: JSON.stringify({ manager_id: id })
                    });
                    const result = await response.json();

                    if (response.ok && result.success) {
                        addManagerToList(result.manager);
                        successCount++;
                    } else {
                        failedIds.push({ id: id, reason: result.error || 'Lỗi không xác định' });
                    }
                } catch (error) {
                    failedIds.push({ id: id, reason: 'Lỗi kết nối' });
                }
            });

            await Promise.all(promises);
            hideLoading();

            if (successCount > 0) {
                showToast(`Đã thêm thành công ${successCount} manager.`, 'success');
            }
            if (failedIds.length > 0) {
                const failedIdsList = failedIds.map(f => `${f.id} (${f.reason})`).join(', ');
                showToast(`Thêm thất bại ${failedIds.length} manager: ${failedIdsList}`, 'error', 10000);
            }
        }    
        function renderRankingTable() {
            const tbody = document.getElementById('rankingTableBody');
            if (!tbody) return;

            const sortKey = currentSort.key;
            const sortDir = currentSort.dir;

            // Special case for rank: it's always based on total_points descending
            if (sortKey === 'rank') {
                processedComparisonData.sort((a, b) => (b.total_points ?? 0) - (a.total_points ?? 0));
            } else {
                processedComparisonData.sort((a, b) => {
                    const valA = a[sortKey];
                    const valB = b[sortKey];

                    if (typeof valA === 'string') {
                        return sortDir === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
                    }
                    return sortDir === 'asc' ? valA - valB : valB - valA;
                });
            }

            tbody.innerHTML = processedComparisonData.map(manager => {
                const index = rankMap.get(manager.id);
                return `
                    <tr>
                        <td>
                            <span class="badge ${index === 0 ? 'bg-warning' :
                                               index === 1 ? 'bg-info' :
                                               index === 2 ? 'bg-bronze' : 'bg-light text-dark'}">${index + 1}</span>
                        </td>
                        <td class="small">${manager.team_name}</td>
                        <td class="${getHighlightClass(manager.total_points, 'total_points')}">${manager.total_points ?? 0}</td>
                        <td class="${getHighlightClass(manager.firstHalfPoints, 'firstHalfPoints')}">${manager.firstHalfPoints}</td>
                        <td class="${getHighlightClass(manager.secondHalfPoints, 'secondHalfPoints')}">${manager.secondHalfPoints}</td>
                        <td class="${getHighlightClass(manager.recordSortValue, 'recordSortValue')}">${manager.recordDisplay}</td>
                        <td class="${getHighlightClass(manager.points_t8, 'points_t8')}">${manager.points_t8 || 0}</td>
                        <td class="${getHighlightClass(manager.points_t9, 'points_t9')}">${manager.points_t9 || 0}</td>
                        <td class="${getHighlightClass(manager.points_t10, 'points_t10')}">${manager.points_t10 || 0}</td>
                        <td class="${getHighlightClass(manager.points_t11, 'points_t11')}">${manager.points_t11 || 0}</td>
                        <td class="${getHighlightClass(manager.points_t12, 'points_t12')}">${manager.points_t12 || 0}</td>
                        <td class="${getHighlightClass(manager.points_t1, 'points_t1')}">${manager.points_t1 || 0}</td>
                        <td class="${getHighlightClass(manager.points_t2, 'points_t2')}">${manager.points_t2 || 0}</td>
                        <td class="${getHighlightClass(manager.points_t3, 'points_t3')}">${manager.points_t3 || 0}</td>
                        <td class="${getHighlightClass(manager.points_t4, 'points_t4')}">${manager.points_t4 || 0}</td>
                        <td class="${getHighlightClass(manager.points_t5, 'points_t5')}">${manager.points_t5 || 0}</td>
                    </tr>
                `;
            }).join('');

            const headers = document.querySelectorAll('#rankingTable thead th[data-sort]');
            headers.forEach(h => {
                h.classList.remove('sort-asc', 'sort-desc');
                if (h.dataset.sort === sortKey) {
                    h.classList.add(sortDir === 'asc' ? 'sort-asc' : 'sort-desc');
                }
            });
        }

        function getHighlightClass(value, key) {
            if (!topScores[key] || value <= 0) return '';
            const scores = topScores[key];
            
            // Gold
            if (value === scores[0]) {
                return 'text-warning fw-bold';
            }
            
            // Silver (only for specific columns)
            if (scores.length > 1 && value === scores[1] && ['total_points', 'firstHalfPoints', 'secondHalfPoints'].includes(key)) { 
                return 'text-info fw-bold';
            }
            
            // Bronze (only for total_points)
            if (scores.length > 2 && value === scores[2] && key === 'total_points') {
                return 'text-bronze fw-bold';
            }
            
            return '';
        }

        function displayComparison(data) {
            const container = document.getElementById('comparisonCharts');

            const gwToMonthMap = {
                't8': [1, 2, 3],
                't9': [4, 5, 6],
                't10': [7, 8, 9],
                't11': [10, 11, 12, 13],
                't12': [14, 15, 16, 17, 18, 19],
                't1': [20, 21, 22, 23, 24],
                't2': [25, 26, 27, 28],
                't3': [29, 30, 31],
                't4': [32, 33, 34],
                't5': [35, 36, 37, 38]
            };

            // Find the single highest score across all managers and gameweeks
            let highestEverScore = -1;
            let recordHoldersInfo = []; // Will store { managerId, gameweek }

            data.managers.forEach(manager => {
                manager.gameweeks.forEach(gw => {
                    if (gw.points > highestEverScore) {
                        highestEverScore = gw.points;
                        recordHoldersInfo = [{ managerId: manager.id, gameweek: gw.gameweek }];
                    } else if (gw.points === highestEverScore && highestEverScore > -1) {
                        recordHoldersInfo.push({ managerId: manager.id, gameweek: gw.gameweek });
                    }
                });
            });

            // If the current gameweek is live, calculate and inject the live points into the gameweeks array.
            // This ensures all subsequent calculations are based on a single, complete source of truth.
            if (currentGameweek && !currentGwFinished) {
                data.managers.forEach(manager => {
                    // Calculate live points from the difference between the live total and the last official total.
                    // This is more robust than relying on a separate 'live_points' field.
                    if (manager.live_total_points && manager.total_points && manager.live_total_points > manager.total_points) {
                        const live_gw_points = manager.live_total_points - manager.total_points;

                        // Find if an entry for the current GW already exists (e.g., from a partially updated API).
                        let gwEntry = manager.gameweeks.find(gw => gw.gameweek === currentGameweek);
                        if (gwEntry) {
                            // Update existing entry with the calculated live points.
                            gwEntry.points = live_gw_points;
                        } else {
                            // If no entry exists, add a new one for the current live gameweek.
                            manager.gameweeks.push({ gameweek: currentGameweek, points: live_gw_points });
                            manager.gameweeks.sort((a, b) => a.gameweek - b.gameweek);
                        }
                    }
                });
            }

            processedComparisonData = data.managers.map(manager => {
                const firstHalfPoints = manager.gameweeks
                    .filter(gw => gw.gameweek >= 1 && gw.gameweek <= 19)
                    .reduce((sum, gw) => sum + gw.points, 0);
                const secondHalfPoints = manager.gameweeks
                    .filter(gw => gw.gameweek >= 20 && gw.gameweek <= 38)
                    .reduce((sum, gw) => sum + gw.points, 0);

                // Use the live total points from the API if available, as it's the most direct and reliable source.
                // Fall back to the calculated sum if live data isn't present.
                // The `gameweeks` array has already been updated with live data, so `firstHalfPoints` and `secondHalfPoints` are correct for their columns.
                const totalPointsFinal = manager.live_total_points ?? (firstHalfPoints + secondHalfPoints);

                // New logic for the record holder column
                const managerRecords = recordHoldersInfo.filter(rh => rh.managerId === manager.id);
                const isRecordHolder = managerRecords.length > 0;
                let recordDisplay = '-';
                if (isRecordHolder) {
                    const gws = managerRecords.map(rec => `GW${rec.gameweek}`).join(', ');
                    recordDisplay = `${highestEverScore} (${gws})`;
                }

                const monthlyPoints = {};
                for (const [key, gws] of Object.entries(gwToMonthMap)) {
                    const monthPoints = manager.gameweeks
                        .filter(gw => gws.includes(gw.gameweek))
                        .reduce((sum, gw) => sum + gw.points, 0);
                    monthlyPoints[`points_${key}`] = monthPoints;
                }

                return {
                    ...manager,
                    total_points: totalPointsFinal,
                    firstHalfPoints, 
                    secondHalfPoints,
                    recordDisplay,
                    recordSortValue: isRecordHolder ? highestEverScore : 0,
                    ...monthlyPoints
                };
            });

            // Calculate top scores for highlighting
            const columnsToRank = {
                total_points: 3, firstHalfPoints: 2, secondHalfPoints: 2, recordSortValue: 1,
                points_t8: 1, points_t9: 1, points_t10: 1, points_t11: 1, points_t12: 1,
                points_t1: 1, points_t2: 1, points_t3: 1, points_t4: 1, points_t5: 1
            };

            topScores = {}; // Reset
            for (const [key, topN] of Object.entries(columnsToRank)) {
                const allScores = processedComparisonData.map(m => m[key]).filter(s => s > 0).sort((a, b) => b - a);
                topScores[key] = [...new Set(allScores)].slice(0, topN);
            }

            // Calculate overall rank map
            rankMap.clear();
            [...processedComparisonData]
                .sort((a, b) => b.total_points - a.total_points)
                .forEach((manager, index) => {
                    rankMap.set(manager.id, index);
                });
            
            // --- Data for weekly scores tab ---
            const maxGameweek = Math.max(0, ...data.managers.flatMap(m => m.gameweeks.map(gw => gw.gameweek)));
            const managerPointsMap = new Map();
            data.managers.forEach(manager => {
                const gwMap = new Map(manager.gameweeks.map(gw => [gw.gameweek, gw.points]));
                managerPointsMap.set(manager.id, gwMap);
            });

            const weeklyScores = [];
            for (let gw = 1; gw <= maxGameweek; gw++) {
                const row = { gameweek: gw, scores: {} };
                let hasData = false;
                data.managers.forEach(manager => {
                    const score = managerPointsMap.get(manager.id)?.get(gw);
                    row.scores[manager.id] = score ?? '-';
                    if (score !== undefined) {
                        hasData = true;
                    }
                });
                // Only add rows for gameweeks that have occurred
                if (hasData) {
                    weeklyScores.push(row);
                }
            }

            // Calculate highest score for each gameweek to highlight it
            weeklyScores.forEach(row => {
                const numericScores = Object.values(row.scores).filter(s => typeof s === 'number');
                // Only set highestScore if there are actual scores for the week
                if (numericScores.length > 0) {
                    row.highestScore = Math.max(...numericScores);
                } else {
                    row.highestScore = null;
                }
            });

            // Prepare data for the transposed weekly scores table. Create a non-mutated reversed array for descending gameweek order.
            reversedWeeklyScores = [...weeklyScores].reverse();

            container.innerHTML = `
                <div class="row">
                    <div class="col-lg-7">
                        <div class="card">
                            <div class="card-header p-0">
                                <ul class="nav nav-tabs card-header-tabs" id="rankingTab" role="tablist">
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link active" id="overall-ranking-tab" data-bs-toggle="tab" data-bs-target="#overall-ranking" type="button" role="tab" aria-controls="overall-ranking" aria-selected="true">BXH Tổng</button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="weekly-scores-tab" data-bs-toggle="tab" data-bs-target="#weekly-scores" type="button" role="tab" aria-controls="weekly-scores" aria-selected="false">Điểm Từng Vòng</button>
                                    </li>
                                </ul>
                            </div>
                            <div class="card-body">
                                <div class="tab-content" id="rankingTabContent">
                                    <div class="tab-pane fade show active" id="overall-ranking" role="tabpanel" aria-labelledby="overall-ranking-tab">
                                        <div class="table-responsive">
                                            <table class="table table-sm table-hover" id="rankingTable">
                                                <thead class="table-dark">
                                                    <tr>
                                                        <th data-sort="rank">Hạng</th>
                                                        <th data-sort="team_name">Đội bóng</th>
                                                        <th data-sort="total_points">Tổng Mùa</th>
                                                        <th data-sort="firstHalfPoints">Lượt Đi</th>
                                                        <th data-sort="secondHalfPoints">Lượt Về</th>
                                                        <th data-sort="recordSortValue">Vua điểm</th>
                                                        <th data-sort="points_t8">T8</th>
                                                        <th data-sort="points_t9">T9</th>
                                                        <th data-sort="points_t10">T10</th>
                                                        <th data-sort="points_t11">T11</th>
                                                        <th data-sort="points_t12">T12</th>
                                                        <th data-sort="points_t1">T1</th>
                                                        <th data-sort="points_t2">T2</th>
                                                        <th data-sort="points_t3">T3</th>
                                                        <th data-sort="points_t4">T4</th>
                                                        <th data-sort="points_t5">T5</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="rankingTableBody"></tbody>
                                            </table>
                                        </div>
                                    </div>
                                    <div class="tab-pane fade" id="weekly-scores" role="tabpanel" aria-labelledby="weekly-scores-tab">
                                        <div class="table-responsive" style="max-height: 500px;">
                                            <table class="table table-sm table-striped table-bordered">
                                                <thead class="table-dark sticky-top">
                                                    <tr>
                                                        <th class="small" style="position: sticky; left: 0; z-index: 1;">Đội bóng</th>
                                                        ${reversedWeeklyScores.map(row => `<th>GW${row.gameweek}</th>`).join('')}
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    ${data.managers.map(manager => `
                                                        <tr>
                                                            <td class="small" style="position: sticky; left: 0; background-color: var(--bs-body-bg, white);">
                                                                <strong>${manager.team_name}</strong>
                                                            </td>
                                                            ${reversedWeeklyScores.map(row => {
                                                                const score = row.scores[manager.id];
                                                                const isHighest = row.highestScore !== null && score === row.highestScore && row.highestScore > 0;
                                                                const isCurrent = row.gameweek === currentGameweek && !currentGwFinished;
                                                                if (isCurrent) {
                                                                    return `<td><span class="text-success fw-bold">${score}</span></td>`;
                                                                }
                                                                return isHighest
                                                                    ? `<td><strong class="text-warning">${score}</strong></td>`
                                                                    : `<td>${score}</td>`;
                                                            }).join('')}
                                                        </tr>`).join('')}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-5">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="bi bi-graph-up"></i> So Sánh Điểm Theo Gameweek</h5>
                            </div>
                            <div class="card-body">
                                <div class="chart-container" style="height: 450px;">
                                    <canvas id="comparisonChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Initial render of the table
            renderRankingTable();

            // Add event listeners for sorting
            const headers = document.querySelectorAll('#rankingTable thead th[data-sort]');
            headers.forEach(header => {
                header.addEventListener('click', () => {
                    const sortKey = header.dataset.sort;
                    if (!sortKey) return;

                    if (sortKey === 'rank') {
                        currentSort = { key: 'total_points', dir: 'desc' };
                    } else if (currentSort.key === sortKey) {
                        currentSort.dir = currentSort.dir === 'asc' ? 'desc' : 'asc';
                    } else {
                        currentSort = { key: sortKey, dir: sortKey === 'team_name' ? 'asc' : 'desc' };
                    }
                    renderRankingTable();
                });
            });

            setTimeout(() => {
                createComparisonChart(data);
            }, 100);
        }

        function exportToExcel() {
            if (processedComparisonData.length === 0 || reversedWeeklyScores.length === 0) {
                showToast('Không có dữ liệu để xuất. Vui lòng "So Sánh Tất Cả" trước.', 'error');
                return;
            }

            try {
                // --- Sheet 1: BXH Tổng ---
                const rankingData = processedComparisonData.map(manager => {
                    const index = rankMap.get(manager.id);
                    return {
                        'Hạng': index + 1,
                        'Đội bóng': manager.team_name,
                        'Tổng Mùa': manager.total_points,
                        'Lượt Đi': manager.firstHalfPoints,
                        'Lượt Về': manager.secondHalfPoints,
                        'Vua điểm': manager.recordDisplay,
                        'T8': manager.points_t8,
                        'T9': manager.points_t9,
                        'T10': manager.points_t10,
                        'T11': manager.points_t11,
                        'T12': manager.points_t12,
                        'T1': manager.points_t1,
                        'T2': manager.points_t2,
                        'T3': manager.points_t3,
                        'T4': manager.points_t4,
                        'T5': manager.points_t5,
                    };
                });
                const rankingWorksheet = XLSX.utils.json_to_sheet(rankingData);

                // --- Sheet 2: Điểm Từng Vòng ---
                const weeklyScoresData = managers.map(manager => {
                    const row = { 'Đội bóng': manager.team_name };
                    reversedWeeklyScores.forEach(gwRow => {
                        row[`GW${gwRow.gameweek}`] = gwRow.scores[manager.id];
                    });
                    return row;
                });
                const weeklyScoresWorksheet = XLSX.utils.json_to_sheet(weeklyScoresData);

                // --- Create and Download Workbook ---
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, rankingWorksheet, 'BXH Tổng');
                XLSX.utils.book_append_sheet(workbook, weeklyScoresWorksheet, 'Điểm Từng Vòng');

                XLSX.writeFile(workbook, 'Fantasy_SoSanh.xlsx');
                showToast('Đã xuất file Excel thành công!', 'success');
            } catch (error) {
                showToast('Lỗi khi xuất Excel: ' + error.message, 'error');
                console.error("Excel export error:", error);
            }
        }

        function createComparisonChart(data) {
            const ctx = document.getElementById('comparisonChart');
            if (!ctx) return;

            const maxGameweeks = Math.max(...data.managers.map(m => m.gameweeks.length));
            const labels = Array.from({length: maxGameweeks}, (_, i) => `GW${i + 1}`);

            const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'];
            
            const datasets = data.managers.map((manager, index) => {
                const pointsData = [];
                for (let gw = 1; gw <= maxGameweeks; gw++) {
                    const gwData = manager.gameweeks.find(g => g.gameweek === gw);
                    pointsData.push(gwData ? gwData.points : null);
                }

                return {
                    label: manager.name.split(' ')[0] + ' ' + manager.name.split(' ')[1]?.charAt(0) + '.',
                    data: pointsData,
                    borderColor: colors[index % colors.length],
                    backgroundColor: colors[index % colors.length] + '20',
                    tension: 0.4,
                    fill: false
                };
            });

            if (charts.comparison) {
                charts.comparison.destroy();
            }

            charts.comparison = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Điểm'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Gameweek'
                            }
                        }
                    }
                }
            });
        }

        async function refreshAllData() {
            showToast('Đang refresh tất cả dữ liệu...', 'info');
            
            await checkConnection();
            
            // Đã được comment để tăng tốc độ refresh, tập trung vào bảng so sánh chính.
            for (const manager of managers) {
                await loadManagerStats(manager.id, false);
            }
            if (managers.length >= 2) {
                await compareAllManagers();
            }
            
            showToast('Đã refresh tất cả dữ liệu!', 'success');
        }

        async function initializeDashboard() {
            const hardcodedIds = [6219866,3596241,3109862,2783491,1450718,4464438,2940974,8041659,346286,4359883,2985317,5458822,3370481,2982855];
            const storedManagersJSON = localStorage.getItem('fantasyManagers');
            let storedManagers = [];

            if (storedManagersJSON) {
                try {
                    storedManagers = JSON.parse(storedManagersJSON);
                } catch (e) {
                    console.error("Lỗi phân tích dữ liệu managers:", e);
                    storedManagers = [];
                }
            }

            const storedIds = storedManagers.map(m => m.id).sort((a, b) => a - b);
            const hardcodedSortedIds = [...hardcodedIds].sort((a, b) => a - b);
            const isListTheSame = storedIds.length === hardcodedSortedIds.length && storedIds.every((value, index) => value === hardcodedSortedIds[index]);

            if (isListTheSame && storedManagers.length > 0) {
                console.log("Đang tải danh sách managers từ bộ nhớ cục bộ.");
                managers = storedManagers;
                document.getElementById('comparisonSection').style.display = 'block';
                await compareAllManagers();

                console.log("Đang tải thông tin chi tiết của từng manager trong nền.");
                for (const manager of managers) {
                    // Tải thông tin chi tiết mà không hiển thị màn hình chờ toàn trang
                    loadManagerStats(manager.id, false);
                }
            } else {
                console.log("Đang tải danh sách managers mới do có sự thay đổi hoặc bộ nhớ trống.");
                showLoading();
                managers = [];
                localStorage.removeItem('fantasyManagers');
                await addManagersInBulk(hardcodedIds);
                if (managers.length > 0) {
                    await compareAllManagers();
                }
                hideLoading();
            }
        }
        // Auto refresh every 5 minutes
        setInterval(refreshAllData, 300000);
    </script>
</body>
</html>
